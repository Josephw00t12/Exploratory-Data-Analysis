---
title: "FA3 Espiritu, Clores"
author: "Espiritu, Joseph Raphael, Harneyyer, Clores"
date: "2026-02-22"
output:
  github_document: default
  html_document:
    df_print: paged
---

```{r}
library(arrow)
library(tidyverse)
library(broom)
library(modelr)
library(robustbase)
library(lubridate)
library(purrr)
```


```{r echo=TRUE}
# ---------------------------------------
# 1️ Load parquet files (Full 2023 Data)
# ---------------------------------------

taxi <- open_dataset("data")

# ---------------------------------------
# 2️ Filter valid trips (Arrow stage)
# ---------------------------------------
taxi_clean <- taxi %>%
  filter(trip_distance > 0,
         total_amount > 0) %>%
  select(trip_distance,
         total_amount,
         tpep_pickup_datetime,
         tpep_dropoff_datetime) %>%
  collect()

# ---------------------------------------
# 3️ Create required variables (In memory)
# ---------------------------------------
taxi_clean <- taxi_clean %>%
  mutate(
    trip_duration_minutes =
      as.numeric(difftime(tpep_dropoff_datetime,
                          tpep_pickup_datetime,
                          units = "mins")),
    
    fare_per_mile =
      total_amount / trip_distance,
    
    month =
      factor(lubridate::month(tpep_pickup_datetime))
  )

# ---------------------------------------
# 4️ Remove extreme outliers (top 1%)
# ---------------------------------------
q_dist <- quantile(taxi_clean$trip_distance, 0.99)
q_fare <- quantile(taxi_clean$total_amount, 0.99)

taxi_trimmed <- taxi_clean %>%
  filter(trip_distance <= q_dist,
         total_amount <= q_fare)

# ---------------------------------------
# 5️ Create modeling sample (for speed)
# ---------------------------------------
set.seed(123)

taxi_model <- taxi_trimmed %>%
  sample_n(200000)

# ---------------------------------------
# 6️ Summary statistics (on modeling data)
# ---------------------------------------
summary(taxi_model)

# ---------------------------------------
# 7️ Scatterplot (use sample to avoid slow plotting)
# ---------------------------------------
ggplot(taxi_model,
       aes(trip_distance, total_amount)) +
  geom_point(alpha = 0.1) +
  labs(title = "Total Amount vs Trip Distance (2023)",
       x = "Trip Distance (Miles)",
       y = "Total Amount ($)")
```


The majority of taxi trips are short-distance rides, resulting in a right-skewed distribution for both trip distance and total fare. The mean exceeding the median further confirms the presence of long-distance extreme values.

The scatterplot reveals a strong positive relationship between trip distance and total fare. As trip distance increases, total fare increases consistently. However, the spread of total fare becomes wider at larger distances. Additionally, horizontal clustering around higher fare values suggests structured pricing patterns such as airport flat fares.

```{r echo=TRUE}
lm_model <- lm(total_amount ~ trip_distance,
               data = taxi_model)

summary(lm_model)

coef(lm_model)

summary(lm_model)$r.squared
```

If slope ≈ 4.62:

For every additional mile traveled, total taxi fare increases by approximately $4.62 on average.

Intercept:

The intercept represents the predicted fare when distance is zero. This approximates the base fare.

The model explains X% of the variation in total_amount using trip_distance alone.

```{r echo=TRUE}
augment(lm_model) %>%
  ggplot(aes(.fitted, .resid)) +
  geom_point(alpha = 0.2) +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Residuals vs Fitted",
       x = "Fitted Values",
       y = "Residuals")
```

Linearity:

Relationship appears mostly linear.

Heteroskedasticity:

Residual spread increases at higher fitted values, indicating non-constant variance.

```{r echo=TRUE}
loess_model <- loess(total_amount ~ trip_distance,
                     data = taxi_model,
                     span = 0.3)

ggplot(taxi_model,
       aes(trip_distance, total_amount)) +
  geom_point(alpha = 0.05) +
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  geom_smooth(method = "loess", color = "red", se = FALSE) +
  labs(title = "Linear vs Flexible (LOESS) Model")

library(modelr)

lm_rmse <- rmse(lm_model, taxi_model)
loess_rmse <- rmse(loess_model, taxi_model)

lm_rmse
loess_rmse
```

If LOESS RMSE slightly smaller:

Flexible modeling captures mild curvature in fare pricing and improves prediction accuracy.

```{r echo=TRUE}
taxi_model <- taxi_model %>%
  mutate(cooks = cooks.distance(lm_model))

top10 <- taxi_model %>%
  arrange(desc(cooks)) %>%
  slice(1:10)

top10

library(robustbase)

robust_model <- lmrob(total_amount ~ trip_distance,
                      data = taxi_model)

summary(robust_model)

coef(lm_model)
coef(robust_model)

predict(lm_model,
        data.frame(trip_distance = 80))

predict(robust_model,
        data.frame(trip_distance = 80))
```

If robust slope smaller:

OLS slope is inflated by extreme values. Robust regression downweights outliers.

Interpret:

Robust model provides more conservative predictions at large distances.

```{r echo=TRUE}
taxi_model <- taxi_model %>%
  mutate(
    quarter = case_when(
      month %in% c("1","2","3") ~ "Q1",
      month %in% c("4","5","6") ~ "Q2",
      month %in% c("7","8","9") ~ "Q3",
      TRUE ~ "Q4"
    )
  )

quarter_slopes <- taxi_model %>%
  group_by(quarter) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(total_amount ~ trip_distance, data = .x)),
    tidy  = map(model, tidy)
  ) %>%
  unnest(tidy)

quarter_slopes

ggplot(taxi_model,
       aes(trip_distance,
           total_amount,
           color = quarter)) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Seasonal Fare-Distance Comparison")
```

Differences in slopes across quarters suggest seasonal variation in marginal fare pricing, potentially due to congestion, demand, or operational adjustments.


Linear modeling is inadequate when the relationship between variables is nonlinear or when error variance is not constant. In the taxi dataset, while trip distance strongly predicts total fare, residual plots indicate increasing variability at larger distances, violating homoskedasticity assumptions. Flexible regression methods such as LOESS allow the model to adapt locally and capture curvature that a single linear slope cannot represent. Large urban datasets also contain extreme values that disproportionately influence ordinary least squares because OLS minimizes squared residuals. These influential observations can distort slope estimates and predictions. Robust regression mitigates this issue by down-weighting extreme residuals, resulting in more stable parameter estimates. Combining classical, flexible, and robust approaches provides a deeper understanding of fare dynamics and ensures more reliable predictive performance.